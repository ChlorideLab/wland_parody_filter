# wland_parody_filter
**【已弃用】** Wland 同人专区屏蔽/筛选文章的爬虫

## 注意事项

微软 Edge 浏览器新版本 `117.0.2045.31` 对 Cookies 的外部访问作了限制，本脚本现**仅对 Google Chrome** 提供可靠的爬取服务。

本仓库代码仅供学习交流用，**切勿用于恶意用途**。

> 竭泽而渔，岂不获得？而明年无鱼。

## Wland 文章条目
为便于后面解释，姑且放一张样图：
![Example](https://gitlab.com/ChlorideP/wland_parody_filter/raw/develop/img/example.jpg)

- 标题 `Title`：虚线上方的加粗文本
- 作者 `Author`：如图所示
- 原型 `Origins`：图示左下角（# 块）  
由于同一个专区存在公共原型（如图为“崩坏三”），实际筛选/屏蔽时不考虑公共原型。
- 标签 `Tags`：图示正底部（:label:块）

输出的文件可能还有 UID WID 两列，详见[产出结果](#产出结果-wland)

## 抓取规则
仅当文章**同时满足**下列条件时，才能添加进筛选结果：
1. **所有**标签、**所有**原型、标题**均未被屏蔽**；
2. 标题**或**标签符合对应要求；
3. 原型符合对应要求。

> 所谓「符合对应要求」，是指在目标范围内，找到**一条**符合限定规则**之一**的记录。  
> 比如匹配标签，就是在「这些标签当中」，找到「其中一条」符合「其中一个要求」的 tag。

从配置文件中**删除**某一环节，或者**为某一环节置`null`**，则跳过该环节（认为符合要求/未被屏蔽）。

## 配置文件 `config.yaml`
**假设**你访问原神专区，浏览器地址栏显示`X.com/special/GenshinImpact`。
请**特别注意标注`!!`的说明**，而不是直接复制粘贴保存。
```yaml
parody: GenshinImpact   # 专区
domain: X.com   # wland 域名 !! 需要替换为能用的真正域名 !!

# 下列选项均选填，不需要可以删除
# 全部删除后相当于没登 Wland 账号，进专区从第一页爬到最后一页，照单全收。
start_page: 1   # 1 <= 起始页 <= 最大页数
end_page: 10    # 起始页 < 最后页 <= 最大页数
adult: False    # 是否过滤成人向内容（若是，则需要浏览器先登上账号）

# 下列选项均允许 留空、只填一个、填入多个 三种写法。示例仅供参考（
ignores: null   # 屏蔽正则（优先检查。留空示例，照单全收）
hashtags: .+ks  # 标签正则（次优先。仅填一个示例，等价于通配符 *ks）
title:          # 标题正则（在标签失配后进行。填入多个示例，只需满足其中之一）
  - '[孙行者][孙行者][孙行者]'
  # 由于中括号在 yaml 里有别的意义，不能直接起头
  # 故用单（双）引号包住表示字符串。
  - all[\u4e00-\u9fff]+
  - (原神|碧蓝档案|碧蓝航线)，启动！
```

### 关于代理
稳定性未知。可向`config.yaml`粘贴如下内容：
```yaml
proxy:
  https: "http://127.0.0.1:port"  # 自改端口号，自行百度如何获知端口号。
```

### 正则表达式简介
通配符`*` `?`用于匹配不定字符，而正则表达式更为强大。
出于篇幅和实用性考虑，这里仅列出我常用的匹配方法。更多骚操作自行百度。

#### 字符匹配
- `.` 表示任意字符。数字、字母、符号、中文……都不在话下。
- `+` 表示**至少一个**前缀字符。
> 与`.`结合就是`.+`，匹配至少一个任意字符。
> 例如，`.+ks`可以匹配`abc123打打ks`，不匹配`ks` `ks123`。
- `*` 表示**0 个以上**前缀字符。
> `all.*`匹配`ally` `all` `all千人律者`（雾）
- `?` 表示**0 个或 1 个**前缀字符。
> `c.?unt`匹配`cunt` `count` `c2unt`，不匹配`c123unt`。

#### 字符范围

- `(abc)` 捕获子串  
> 上面的「字符匹配」如其名，只匹配单字。  
> 欲同时匹配`空` `原神空`，显然`原?神?空`这样每个字都匹配不切实际。  
> 更好的做法是 `(原神)?空`。
- `(..|..|..)` n 选一。  
> 比如`config.yaml`中的模式串，匹配`碧蓝航线，启动！`，不匹配`明日方舟，启动！`。
- `[abcde]` <=> `(a|b|c|d|e)`
- `[a-zA-Z0-9]`
- `[\u4E00-\u4FFF]`
表示这个单字落在`[]`框定的范围内。  
> 比如`[孙行者][孙行者][孙行者]`，匹配`孙行者` `行者孙` `孙者行`……  
> 又比如`[a-zA-Z]+`匹配全部英文单词`a` `alloc` ……  
> 至于区间`[\u4E00, \u4FFF]`，它表示大部分常用的中文汉字。直接复制使用即可。

> 冷知识，Unicode 字符集收录的中文汉字可能已经超过 100,000 个。  
> 截至 2020 年下旬，就已经收录 98,000 余个了。


## 异常处理
- 还没开始爬就报错：请**先关闭所有浏览器**。
- 在挂了代理的情况下，有可能出现以下错误：**建议关闭加速器**重试。有更好的办法欢迎分享。

```log
[2023-08-14 16:12:26,406] CRITICAL: Abnormal network!
  HTTPSConnectionPool(host='...', port=443): Max retries exceeded with url: ... (Caused by SSLError(SSLEOFError(8, 'EOF occurred in violation of protocol (_ssl.c:1002)')))
[2023-09-15 00:09:40,399] CRITICAL: Abnormal network!
  ('Connection aborted.', ConnectionResetError(10054, '远程主机强迫关闭了一个现有的连接。', None, 10054, None))
```

## 产出结果 `wland.*`
默认是`wland.csv`，可以用 Excel 或记事本打开。  
除`CSV`外，`renderer.py`还提供了`MarkDown`和`HTML`文件的支持。

如需更改，可在`main.py`里将
```python
sheet_file = renderer.CSV('./wland.csv')
```
替换为其他格式：
```python
sheet_file = renderer.MarkDown('./wland.md', CONFIG['domain'])
```
```python
sheet_file = renderer.HTML('./wland.html', CONFIG['domain'])
```